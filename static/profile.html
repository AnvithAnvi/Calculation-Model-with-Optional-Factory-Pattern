<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Profile</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 720px; margin: 2rem auto; }
    label { display:block; margin-top:1rem }
    input { width: 100%; padding: .5rem }
    button { margin-top: .8rem; padding: .6rem 1rem }
    .msg { margin-top: .6rem }
    .msg.success { color: green }
    .msg.error { color: red }
  </style>
</head>
<body>
  <h1>Profile</h1>
  <div>
    <h2>Update Profile</h2>
    <div>
      <label>Username
        <input id="username" />
      </label>
      <label>Email
        <input id="email" />
      </label>
      <button id="saveProfile">Save</button>
      <div class="msg success" style="display:none"></div>
      <div class="msg error" style="display:none"></div>
    </div>
  </div>

  <div>
    <h2>Change Password</h2>
    <label>Current Password
      <input id="current_password" type="password" />
    </label>
    <label>New Password
      <input id="new_password" type="password" />
    </label>
    <button id="changePassword">Change Password</button>
    <div class="msg success" style="display:none"></div>
    <div class="msg error" style="display:none"></div>
  </div>

  <div style="margin-top:1rem">
    <button id="logout">Logout</button>
  </div>

<script>
const token = localStorage.getItem('access_token')
if (!token) {
  window.location.href = '/static/login.html'
}

function showMsg(el, text, ok=true){
  el.style.display='block'; el.textContent=text; el.className='msg ' + (ok? 'success':'error')
  setTimeout(()=>{ el.style.display='none' }, 4000)
}

async function loadProfile(){
  const r = await fetch('/users/me', { headers: { 'Authorization': 'Bearer ' + token } })
  if (r.status === 200){
    const j = await r.json()
    document.getElementById('username').value = j.username || ''
    document.getElementById('email').value = j.email || ''
  } else {
    window.location.href='/static/login.html'
  }
}

document.getElementById('saveProfile').addEventListener('click', async ()=>{
  const username = document.getElementById('username').value
  const email = document.getElementById('email').value
  const r = await fetch('/users/me', { method: 'PUT', headers: { 'Content-Type':'application/json','Authorization':'Bearer '+token }, body: JSON.stringify({ username, email }) })
  const successEl = document.querySelectorAll('.msg.success')[0]
  const errorEl = document.querySelectorAll('.msg.error')[0]
  if (r.status === 200){
    const j = await r.json(); showMsg(successEl, 'Profile updated', true)
  } else {
    const txt = await r.text(); showMsg(errorEl, txt || 'Error', false)
  }
})

document.getElementById('changePassword').addEventListener('click', async ()=>{
  const current = document.getElementById('current_password').value
  const nw = document.getElementById('new_password').value
  const r = await fetch('/users/me/password', { method: 'POST', headers: { 'Content-Type':'application/json','Authorization':'Bearer '+token }, body: JSON.stringify({ current_password: current, new_password: nw }) })
  const successEl = document.querySelectorAll('.msg.success')[1]
  const errorEl = document.querySelectorAll('.msg.error')[1]
  if (r.status === 200){
    showMsg(successEl, 'Password changed', true)
    // clear stored token, require re-login
    localStorage.removeItem('access_token')
    setTimeout(()=>{ window.location.href='/static/login.html' }, 1000)
  } else {
    const txt = await r.text(); showMsg(errorEl, txt || 'Error', false)
  }
})

document.getElementById('logout').addEventListener('click', ()=>{
  localStorage.removeItem('access_token'); window.location.href = '/'
})

loadProfile()
</script>
</body>
</html>
